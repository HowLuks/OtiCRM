/**
 * @fileoverview Firestore Security Rules for OtiCRM application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model. Each user has a private data tree rooted at `/users/{userId}`.
 * Only the authenticated user matching the `userId` path segment can read and write data within their own tree.
 *
 * Data Structure:
 * All data (prospects, stages, reports) is nested under `/users/{userId}`. This ensures data isolation and simplifies security rules.
 *
 * Key Security Decisions:
 * - User listing is disallowed.
 * - Data validation is relaxed to allow for rapid prototyping (no schema enforcement).
 * - Authorization relies exclusively on the authenticated user's UID matching the path's `userId`.
 *
 * Denormalization for Authorization:
 * The security rules rely on the path `/users/{userId}` matching the authenticated user's `uid`.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secures access to prospect documents. Only the owning user can create, read, update, or delete their own prospects.
     * @path /users/{userId}/prospects/{prospectId}
     * @allow (create) - User 'YuKoahbnTsfgPkU9cOaKC36re9y2' can create a prospect under /users/YuKoahbnTsfgPkU9cOaKC36re9y2/prospects/T2FQbMcb0aMhaqKE0bCc.
     * @allow (get) - User 'YuKoahbnTsfgPkU9cOaKC36re9y2' can get a prospect under /users/YuKoahbnTsfgPkU9cOaKC36re9y2/prospects/T2FQbMcb0aMhaqKE0bCc.
     * @allow (update) - User 'YuKoahbnTsfgPkU9cOaKC36re9y2' can update a prospect under /users/YuKoahbnTsfgPkU9cOaKC36re9y2/prospects/T2FQbMcb0aMhaqKE0bCc.
     * @allow (delete) - User 'YuKoahbnTsfgPkU9cOaKC36re9y2' can delete a prospect under /users/YuKoahbnTsfgPkU9cOaKC36re9y2/prospects/T2FQbMcb0aMhaqKE0bCc.
     * @deny (create) - User 'AnotherUserId' cannot create a prospect under /users/YuKoahbnTsfgPkU9cOaKC36re9y2/prospects/T2FQbMcb0aMhaqKE0bCc.
     * @principle Enforces document ownership for all operations on prospects.
     */
    match /users/{userId}/prospects/{prospectId} {
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Secures access to stage documents. Only the owning user can create, read, update, or delete their own stages.
     * @path /users/{userId}/stages/{stageId}
     * @allow (create) - User 'YuKoahbnTsfgPkU9cOaKC36re9y2' can create a stage under /users/YuKoahbnTsfgPkU9cOaKC36re9y2/stages/stage123.
     * @allow (get) - User 'YuKoahbnTsfgPkU9cOaKC36re9y2' can get a stage under /users/YuKoahbnTsfgPkU9cOaKC36re9y2/stages/stage123.
     * @allow (update) - User 'YuKoahbnTsfgPkU9cOaKC36re9y2' can update a stage under /users/YuKoahbnTsfgPkU9cOaKC36re9y2/stages/stage123.
     * @allow (delete) - User 'YuKoahbnTsfgPkU9cOaKC36re9y2' can delete a stage under /users/YuKoahbnTsfgPkU9cOaKC36re9y2/stages/stage123.
     * @deny (create) - User 'AnotherUserId' cannot create a stage under /users/YuKoahbnTsfgPkU9cOaKC36re9y2/stages/stage123.
     * @principle Enforces document ownership for all operations on stages.
     */
    match /users/{userId}/stages/{stageId} {
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Secures access to report documents. Only the owning user can create, read, update, or delete their own reports.
     * @path /users/{userId}/reports/{reportId}
     * @allow (create) - User 'YuKoahbnTsfgPkU9cOaKC36re9y2' can create a report under /users/YuKoahbnTsfgPkU9cOaKC36re9y2/reports/report123.
     * @allow (get) - User 'YuKoahbnTsfgPkU9cOaKC36re9y2' can get a report under /users/YuKoahbnTsfgPkU9cOaKC36re9y2/reports/report123.
     * @allow (update) - User 'YuKoahbnTsfgPkU9cOaKC36re9y2' can update a report under /users/YuKoahbnTsfgPkU9cOaKC36re9y2/reports/report123.
     * @allow (delete) - User 'YuKoahbnTsfgPkU9cOaKC36re9y2' can delete a report under /users/YuKoahbnTsfgPkU9cOaKC36re9y2/reports/report123.
     * @deny (create) - User 'AnotherUserId' cannot create a report under /users/YuKoahbnTsfgPkU9cOaKC36re9y2/reports/report123.
     * @principle Enforces document ownership for all operations on reports.
     */
    match /users/{userId}/reports/{reportId} {
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }
  }

  // Helper functions
  function isSignedIn() {
    return request.auth != null;
  }

  function isOwner(userId) {
    return request.auth.uid == userId;
  }

  function isExistingOwner(userId) {
    return isSignedIn() && isOwner(userId) && resource != null;
  }
}